var _Doneski=function(){var f=this;f.linger=1E3;f.list_name="default";f.separator="::";f.tag=function(k,h,o){k=document.createElement(k);if(!o&&typeof h=="string")o=h=undefined;if(h)for(var q in h)k.setAttribute(q,h[q]);if(o)k.innerHTML=o;return k};f.bind=function(k,h){h=h||f;return function(){k.apply(h,arguments)}};f.l=[];f.id="doneski";var u={_init:function(){f.lcon=(gtn=f.gtn)((l="list")+"s")[0];f.ln=gtn(l+"nav")[0];f.tb=t=gtn(tb="toolbar")[0];f.fudge=gtn("content")[0];if((ls="localStorage")in
(w=window)&&w[ls]!==null){f.touch();f.currentJournal=parseInt(w[ls][(j="journal.")+"current"]||1,10);f.lastSync=parseInt(w[ls][j+"lastsync"]||0,10);if(!w[ls][j+"started"])f.do_journal=true;w.scrollTo(0,35);if(localStorage[l+"s"]){var k=w[ls][l+"s"].split(",");f.rollup();for(var h=0;h<k.length;h++)f.lL(k[h]);(k=w[ls]["last_"+l]?f.find(w[ls]["last_"+l]):f.l[0])||(k=f.l[0]);f.go(k)}else f.newList();f.sFH()}(ael=f.ael)("keyup",f.bkp,true);if(typeof TouchyFeely!="undefined"){f.toucher=new TouchyFeely(document,
{mL:10,cscroll:0});ael((a="swipe")+"start",f.swS,true);ael(a+"move",f.swM,true);ael(a+"end",f.swE,true);ael((a="scroll")+"start",f.scS,true);ael(a+"move",f.scM,true);ael(a+"end",f.scE,true)}(st=w.setTimeout)(function(){f.gtn("body")[0].className+=" loaded"},200);st(function(){f.cachedTexture(tb,f.ns,{opacity:0.3,range:50},tb)},0);st(function(){f.cachedTexture("body "+l+"s "+l,f.nb,{bg:{position:"20px top",repeat:"repeat-y"}},"nb")},0);st(function(){f.cachedTexture("body header",f.nb,{bg:{position:"20px top",
repeat:"repeat-y"}},"nb")},0);w.scrollTo(0,0);st(f.sync,1E3);w[ls][j+"started"]=1;f.loaded=f.do_journal=f.do_sync=true},ael:function(k,h,o){return document.addEventListener(k,h,o)},gtn:function(k){return document.getElementsByTagName(k)},ns:function(k,h,o,q){h={opacity:0.2,range:100};if(k)for(var r in k)h[r]=k[r];if(!(d=document)[ce="createElement"]("canvas").getContext)return false;q=(o=d[ce]("canvas")).getContext("2d");o.width=h.width||960;o.height=h.height||30;for(k=0;k<o.width;k++)for(r=0;r<o.height;r++){var v=
Math.floor(Math.random()*h.range);q.fillStyle="rgba("+v+","+v+","+v+","+h.opacity+")";q.fillRect(k,r,1,1)}return"url("+o.toDataURL("image/png")+")"},nb:function(k,h,o,q,r,v){if(!(q=document)[ce="createElement"]("canvas").getContext)return false;v=(r=q[ce]("canvas")).getContext("2d");r.width=4;r.height=1;v.fillStyle="rgba(236,0,140,.2)";v.fillRect(0,0,1,1);v.fillRect(3,0,1,1);return"url("+r.toDataURL("image/png")+")"},cachedTexture:function(k,h,o,q,r,v,x){q&&(w=window)[ls="localStorage"][q="tx."+q]&&
(v=w[ls][q]);r={bg:{repeat:"no-repeat",position:"left top"}};if(o)for(x in o)r[x]=o[x];if(!v){v=h(o);w[ls][q]=v}(st=f.styles()).innerHTML+=k+"{"+(b="background-")+"image:"+v+";";for(x in bg=r.bg)st.innerHTML+=b+x+":"+bg[x]+";";st.innerHTML+="}\n";return true},styles:function(){if(f.css)return f.css;f.css=(d=document).createElement("style");d.getElementsByTagName("head")[0].appendChild(f.css);return f.css},swS:function(){(g=(f.swT=f.cL)["get"+(a="Attribute")]("style")||"").indexOf(w="-webkit-transform:translate3d(");
f.swiping=true},swM:function(){},swE:function(k){(function(h){window.setTimeout(function(){h.removeAttribute("style")},200)})(f.swT);k.direction=="left"?f.goN():f.goP()},scS:function(){if((a=(f.scT=f.cL).getAttribute("style")||"").indexOf(w="-webkit-transform:translate3d(")==-1){f.scT.setAttribute("style",a+w+"0px,0px,0px);-webkit-transition:none;");f.scS=0}else f.scS=parseInt(a.replace(/.*-webkit-transform:translate3d\((-)?[0-9]{1,5}(px)?,((-)?[0-9]{1,5})(px)?,.*/,"$3"),10)},scM:function(k,h){h=
(e=f.scS+k.dY)>0?0:e<(d=f.mSc())?d:e;f.scT.setAttribute("style",f.scT.getAttribute("style").replace(/-webkit-transform:translate3d\(((-)?[0-9]{1,5}(px)?),(-)?[0-9]{1,5}(px)?,/,"-webkit-transform:translate3d($1,"+h+"px,"))},scE:function(){f.scT.setAttribute("style",f.scT.getAttribute("style").replace("-webkit-transition:none;",""))},mSc:function(){return 0-f.scT.clientHeight+window.innerHeight},lL:function(k,h,o,q){(o=new Doneski.List(k)).nav_item=q=new Doneski.ListNav(o);f.addList(o.id);h&&(o.className+=
h);f.lcon.appendChild(o);f.ln.appendChild(q);f.rN();return o},addList:function(k){f.l.push(window.o_register[k]||f.lL(k))},rN:function(){ln=f.ln;if(ln.clientWidth>f.tb.clientWidth*0.9){a="tight";for(p=4;p--;)ln.className=ln.className.replace(a+(p-1),a+p)}},newList:function(k){k=f.lL(f.gLId(),"after");f.go(k)},find:function(k){for(var h=0;h<f.l.length;h++)if(f.l[h].id==k)return f.l[h]},go:function(k){for(var h="",o=0;o<f.l.length;o++)if(f.l[o]!=k)f.l[o].deactivate(h);else{f.l[o].activate();h="after"}f.cL=
k;f.sFH();localStorage.last_list=k.id},sFH:function(){if((s=f.styles())&&s.innerHTML.indexOf("/*fudge heights*/")==-1)f.styles().innerHTML+="\n/*fudge heights*/content,lists list{min-height:"+window.innerHeight+"px;}";else f.styles().innerHTML.replace("\n/*fudge heights*/content,lists list{[^}]+}","\n/*fudge heights*/content,lists list{min-height:"+window.innerHeight+"px;}")},goN:function(){var k=f.l.indexOf(f.cL)+1;k>=f.l.length?f.newList():f.go(f.l[k])},goP:function(){var k=f.l.indexOf(f.cL)-1;
k>=0&&f.go(f.l[k])},gTId:function(){return"t_"+f.gUU()},gLId:function(){return"l_"+f.gUU()},gUU:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(k){var h=Math.random()*16|0;return(k=="x"?h:h&3|8).toString(16)})+""},saveLists:function(){for(var k=[],h=0;h<f.l.length;h++)k.push(f.l[h].id);localStorage.lists=k},store:function(){localStorage.lists=[f.list_name,false];var k=[],h;for(h in f.tasks){var o=[h,f.tasks[h]].join(f.separator);f.tasks[h]||k.push(o)}localStorage["lists."+
f.list_name]=k.join(",")},rollup:function(){if((bdy=document.getElementsByTagName("body")[0])&&bdy.className.indexOf("compact")<0)bdy.className+=" compact";window.scrollTo(0,0)},rollupQuick:function(){if((bdy=document.getElementsByTagName("body")[0])&&bdy.className.indexOf("quick")<0)bdy.className+=" quick";if((bdy=document.getElementsByTagName("body")[0])&&bdy.className.indexOf("compact")<0)bdy.className+=" compact";window.scrollTo(0,0)},add:function(){},touch:function(){f.hLS()&&(localStorage.lastSeen=
new Date)},lastSeen:function(){return f.hLS()&&localStorage.lastSeen},hLS:function(){return"localStorage"in window&&window.localStorage!==null},ping:function(){},bkp:function(k){if(k.keyCode==39)f.goN();else k.keyCode==37&&f.goP()},intercepts:["addList"],queue:[0,1,2,3,4,5,6,7,8,9],newJournal:function(){(l=localStorage)[(j="journal.")+"unsynced"]||((l=localStorage)[(j="journal.")+"unsynced"]="");if(f[c="currentJournal"])(l=localStorage)[(j="journal.")+"unsynced"]+=f[c]+",";f[c]=f[c]?f[c]+1:1;l[j+
"current"]=f[c]},journal:function(){if(f.do_journal){(a=Array.prototype.slice.call(arguments)[0]).unshift((new Date).getTime()-(d=f.queue.shift()));f.queue.push(f.queue[f.queue.length-1]+1);localStorage["journal."+f.currentJournal]=f.serialize(a);f.newJournal();f.needsSync=1}},sync:function(k,h,o){if(f.do_sync&&!f.syncing&&f.needsSync){f.syncing=1;f.syncer||(f.syncer=new Doneski.Synchro(f));if(f.syncer.online()){k=(l=localStorage)[(j="journal.")+"unsynced"].split(",");for(h in k)if(l[j+h])(o=o||[]).push([parseInt(h,
10),JSON.parse(l[j+h])]);f.upload(f.serialize({lastsync:f.lastSync,account:"test",device:"test",data:o}))}f.syncing=0}},upload:function(k,h){try{h=new XMLHttpRequest;h.open("POST","/sync",1);h.onreadystatechange=f.upback;h.send(k)}catch(o){return 0}return 1},upback:function(k,h,o){if(k.target.readyState==4){h=eval("("+k.target.responseText+")");for(p in o=h.synced){(l=localStorage)[(j="journal.")+"unsynced"].replace(RegExp("^"+(n=o[p])+",|,"+n+","),",");l.removeItem(j+n)}f.replay(h.replay);f.justsynced();
f.needsSync=0}},justsynced:function(){f.lastSync=(new Date).getTime();l["journal.lastsync"]=f.lastSync},replay:function(k){f.replaying=1;for(p=0;p<k.length;p++){var h=eval("("+k[p]+")"),o=window.o_register[h[1]];o&&o[h[2]]&&o[h[2]].apply(o,h[3]);console.log(h,o)}f.replaying=0;return true},serialize:function(k){return JSON.stringify(k)}},p;for(p in u)f[p]=u[p];return new Syncer(new _Journaller(f))};
_Doneski.prototype.Synchro=function(f,u,p){p=this;f={intervals:[3E4,9E4,36E4],retries:4,offs:0,speed:-1,_init:function(){},online:function(){p.onLine=0;try{var h=new XMLHttpRequest;h.open("HEAD","/ping",0);h.send();p.onLine=1;p.offs=0;p.setSpeed(0)}catch(o){p.onLine=0;p.offs++;p.offs>p.retries&&p.setSpeed(parseInt(p.offs/p.retries,10))}return p.onLine},setSpeed:function(h){if(h!=p.speed&&p.intervals[h]){p.timer&&window.clearInterval(p.timer);p.timer=window.setInterval(p.ping,p.intervals[h]);p.speed=
h}},ping:function(){p.online()}};for(var k in f)p[k]=f[k];p._init(u);return p};
_Doneski.prototype.List=function(f,u,p,k){p=Doneski.tag;var h=p("list");h.name_input=p("input",{type:"text",name:"title",placeholder:"Name this list","class":"delayed"});h.appendChild(h.name_input);h.form=p("form",{action:"/task",method:"post","class":"tasklist"});h.appendChild(h.form);h.task_input=p("input",{type:"text","class":"task",placeholder:"Add your first to-do"});h.form.appendChild(h.task_input);h.form.appendChild(p("input",{type:"submit",value:"Add",style:"display:none;"}));h.task_container=
p("tasks",{"class":"active"});h.appendChild(h.task_container);h.completed_container=p("tasks",{"class":"completed"});h.appendChild(h.completed_container);p={name:function(q){localStorage["lists."+h.id+".name"]=q;h.name_input.className="setted";h.task_input.focus();h.updated("name")},nameB:function(q){h.name(q.target.value)},nameK:function(q){q.keyCode==13&&h.name(q.target.value)},formHandler:function(q){q.preventDefault();Doneski.rollup();h.push(h.task_input.value);h.task_input.value="";return false},
push:function(q){q=new Doneski.Task(h,q);h.task_container.insertBefore(q,h.task_container.firstChild);(!(l=localStorage.lists)||l.split(",").indexOf(h.id)==-1)&&h.create(h.id);h.addTask(q.id);q.addEventListener("kill",h.deathWatch,true);q.addEventListener("update",function(){},true)},addTask:function(q){(a=h.items.indexOf(q))==-1&&h.items.push(q)&&h.updated("add")},updated:function(q,r){Doneski.loaded&&h.save();h.task_input.setAttribute("placeholder",h.items.length?"Add another one":"Add your first to-do");
Doneski.sFH();(r=document["create"+(e="Event")]("UI"+e+"s"))["initUI"+e](q||"update",true,true,window,1);r.l_id=h.id;h["dispatch"+e](r)},loadTask:function(q){q=new Doneski.Task(h,false,q);q.completed?h.completed_container.insertBefore(q,h.completed_container.firstChild):h.task_container.insertBefore(q,h.task_container.firstChild);h.items.push(q.id);h.task_input.setAttribute("placeholder","Add another one")},create:function(q){var r=localStorage.lists?localStorage.lists.split(","):[];r.push(q);localStorage.lists=
r},save:function(){(!(l=localStorage.lists)||l.split(",").indexOf(h.id)==-1)&&h.create(h.id);localStorage["lists."+h.id]=h.items.join(",")},deathWatch:function(q){h.removeTask(q.t_id)},removeTask:function(q){(a=h.items.indexOf(q))>-1&&h.items.splice(h.items.indexOf(q),1);h.updated("remove")},focus:function(){h.task_input.focus()},activate:function(){h.className="active";h.nav_item.className="active";h.old_style&&h.setAttribute("style",h.old_style)},deactivate:function(q){h.className=q||"";h.nav_item.className=
"";h.old_style=h.getAttribute("style");h.removeAttribute("style")}};for(var o in p)h[o]=p[o];h.form.list=h;h.form.addEventListener("submit",h.formHandler,true);h.name_input.addEventListener("blur",h.nameB,true);h.name_input.addEventListener("keypress",h.nameK,true);h.id=f;h.title=u||"";h.items=[];if(localStorage["lists."+h.id+".name"]){h.name_input.value=localStorage["lists."+h.id+".name"];h.name_input.className="setted"}if(localStorage["lists."+h.id]&&(k=localStorage["lists."+h.id].split(",")))for(o=
0;o<k.length;o++)h.loadTask(k[o]);h.intercepts=["addTask","removeTask","name"];h.sync_intercepts=h.intercepts;h.journal=Doneski.journal;h.sync=Doneski.sync;h=new Syncer(h);return h=new _Journaller(h)};_Doneski.prototype.ListNav=function(f){var u=Doneski.tag;u=u("list",{"class":"hidden"});u.list=f;return u};
_Doneski.prototype.Task=function(f,u,p){var k=Doneski.tag("task",{});k.list=f;if(p&&localStorage["tasks."+p]){u=localStorage["tasks."+p].split(Doneski.separator);f=u[0];u=u[1]=="true";k.id=p}else{if(typeof u=="string"){f=u;u=false}else{f=u[0];u=u[1]=="true"}k.id=Doneski.gTId()}p={taskClick:function(){if(!k.nocancel){k.className+=" clicky";k.completed?window.setTimeout(function(){k.uncomplete()},1E3):window.setTimeout(function(){k.complete()},1E3)}k.nocancel=false},taskMove:function(){k.nocancel=true},
save:function(){k.killed?localStorage.removeItem("tasks."+k.id):localStorage["tasks."+k.id]=[k.innerHTML,k.completed].join(Doneski.separator)},complete:function(){k.className="";k.list.completed_container.insertBefore(k,k.list.completed_container.firstChild);k.completed=true;k.updated("complete")},uncomplete:function(){k.list.task_container.insertBefore(k,k.list.task_container.firstChild);k.className="active";k.completed=false;k.updated("uncomplete")},kill:function(){k.killed&&k.updated("kill")},
updated:function(o,q){Doneski.loaded&&k.save();Doneski.sFH();(q=document.createEvent("UIEvents")).initUIEvent(o||"update",true,true,window,1);q.t_id=k.id;k.dispatchEvent(q)},setText:function(o){k.innerHTML=o}};for(var h in p)k[h]=p[h];k.addEventListener("click",k.taskClick,true);k.addEventListener("touchmove",k.taskMove,true);k.addEventListener("touchend",k.taskClick,true);k.completed=u;if(!k.completed)k.className="active";k.intercepts=["complete","uncomplete","kill","setText","create"];k.sync_intercepts=
k.intercepts;k.journal=Doneski.journal;k.sync=Doneski.sync;k=new Syncer(k);k=new _Journaller(k);k.setText(f);k.save();return k};
var _Journaller=function(f,u,p,k,h,o){if(f.intercepts){k=function(){f.journal&&f.journal.call&&f.journal(Array.prototype.slice.call(arguments))};p=function(r,v){if(!f.replaying){v=Array.prototype.slice.call(v);k(f.id,r,v)}return q[r].apply(f,v)};var q=[];for(o=0;o<f.intercepts.length;o++){q[m=f.intercepts[o]]=f[m];(function(r,v){if(v)r[v]=function(){p.apply(r,[v,arguments])}})(f,m)}}window.o_register||(window.o_register={});return window.o_register[f.id]=f},Syncer=function(f,u,p,k){if(f.sync_intercepts){u=
function(){f.sync&&f.sync.call&&f.sync(Array.prototype.slice.call(arguments))};p=function(h,o){u(f.id,h,o=Array.prototype.slice.call(o));return k[h].apply(f,o)};k=[];for(i=0;i<f.sync_intercepts.length;i++){k[m=f.sync_intercepts[i]]=f[m];(function(h,o){if(o)h[o]=function(){p.apply(h,[o,arguments])}})(f,m)}}return f};window.Doneski=new _Doneski;window.applicationCache.addEventListener("updateready",function(){window.applicationCache.swapCache()},true);window.setTimeout("Doneski._init();",0);
